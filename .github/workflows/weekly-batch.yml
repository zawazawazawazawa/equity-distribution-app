name: Weekly Batch Processing

on:
  schedule:
    - cron: '0 0 * * 5'  # 毎週金曜 0:00 UTC (日本時間 金曜 9:00)
  workflow_dispatch:
    inputs:
      start_date:
        description: '開始日 (YYYY-MM-DD)。未指定の場合は7日後から'
        required: false
        type: string
      days_count:
        description: '処理日数'
        required: false
        default: '7'
        type: string

jobs:
  batch:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      - name: Run migrations
        working-directory: backend
        run: go run cmd/migrate/main.go up
        env:
          POSTGRES_HOST: ${{ secrets.POSTGRES_HOST }}
          POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          POSTGRES_DBNAME: ${{ secrets.POSTGRES_DBNAME }}
          POSTGRES_SSLMODE: require

      - name: Build batch processor
        working-directory: backend
        run: go build -o batch-processor batch/main.go

      - name: Run batch processing
        working-directory: backend
        run: |
          DAYS_COUNT="${{ inputs.days_count || '7' }}"
          INPUT_DATE="${{ inputs.start_date }}"
          if [ -n "${INPUT_DATE}" ]; then
            START_DATE="${INPUT_DATE}"
          else
            START_DATE=$(date -d "+7 days" "+%Y-%m-%d")
          fi
          echo "Start date: ${START_DATE}"
          echo "Processing ${DAYS_COUNT} days..."
          for i in $(seq 0 $((DAYS_COUNT - 1))); do
            CURRENT_DATE=$(date -d "${START_DATE} + ${i} days" "+%Y-%m-%d")
            echo "===== Processing: ${CURRENT_DATE} ====="
            ./batch-processor \
              -data data -date "${CURRENT_DATE}" \
              -adaptive -monte-carlo-mode ACCURATE -jobs 2 \
              -pg-host "${POSTGRES_HOST}" -pg-port 5432 \
              -pg-user "${POSTGRES_USER}" -pg-password "${POSTGRES_PASSWORD}" \
              -pg-dbname "${POSTGRES_DBNAME}" \
            || echo "ERROR: Failed for ${CURRENT_DATE}, continuing..."
          done
          echo "===== All ${DAYS_COUNT} days processed ====="
        env:
          POSTGRES_HOST: ${{ secrets.POSTGRES_HOST }}
          POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          POSTGRES_DBNAME: ${{ secrets.POSTGRES_DBNAME }}
          POSTGRES_SSLMODE: require
          R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
          R2_ACCESS_KEY: ${{ secrets.R2_ACCESS_KEY }}
          R2_SECRET_KEY: ${{ secrets.R2_SECRET_KEY }}
          R2_BUCKET: ${{ secrets.R2_BUCKET }}
          EnableImageUpload: "true"
