name: Daily Batch Processing

on:
  schedule:
    - cron: '0 0 * * *'  # 毎日 0:00 UTC (日本時間 9:00)
  workflow_dispatch:

permissions:
  contents: read

jobs:
  batch:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - uses: actions/setup-go@d35c59abb061a4a6fb18e82ac0862c26744d6ab5 # v5.5.0
        with:
          go-version: '1.23'

      - name: Run migrations
        working-directory: backend
        run: go run cmd/migrate/main.go up
        env:
          POSTGRES_HOST: ${{ secrets.POSTGRES_HOST }}
          POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          POSTGRES_DBNAME: ${{ secrets.POSTGRES_DBNAME }}
          POSTGRES_SSLMODE: require

      - name: Build batch processor
        working-directory: backend
        run: go build -o batch-processor batch/main.go

      - name: Run daily batch processing
        working-directory: backend
        run: |
          echo "===== Running daily auto-next batch ====="
          ./batch-processor \
            -data data -auto-next \
            -adaptive -monte-carlo-mode ACCURATE -jobs 2 \
            -pg-host "${POSTGRES_HOST}" -pg-port 5432 \
            -pg-user "${POSTGRES_USER}" -pg-password "${POSTGRES_PASSWORD}" \
            -pg-dbname "${POSTGRES_DBNAME}"
          echo "===== Daily batch completed ====="
        env:
          POSTGRES_HOST: ${{ secrets.POSTGRES_HOST }}
          POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          POSTGRES_DBNAME: ${{ secrets.POSTGRES_DBNAME }}
          POSTGRES_SSLMODE: require
          R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
          R2_ACCESS_KEY: ${{ secrets.R2_ACCESS_KEY }}
          R2_SECRET_KEY: ${{ secrets.R2_SECRET_KEY }}
          R2_BUCKET: ${{ secrets.R2_BUCKET }}
          EnableImageUpload: "true"
