version: "3.8"

services:
  localstack:
    image: localstack/localstack:latest
    container_name: localstack_plo
    ports:
      - "4566:4566" # LocalStack Gateway
      - "4510-4559:4510-4559" # external services port range
    environment:
      - SERVICES=dynamodb
      - DEBUG=1
      - DATA_DIR=/tmp/localstack/data
      - DOCKER_HOST=unix:///var/run/docker.sock
      - AWS_DEFAULT_REGION=us-east-1
      - AWS_ACCESS_KEY_ID=dummy
      - AWS_SECRET_ACCESS_KEY=dummy
    volumes:
      - "${LOCALSTACK_VOLUME_DIR:-./volume}:/var/lib/localstack"
      - "/var/run/docker.sock:/var/run/docker.sock"
      - ./scripts:/docker-entrypoint-initaws.d # スクリプトディレクトリをマウント
      - ./export.json:/docker-entrypoint-initaws.d/export.json
      - ./import-items.json:/docker-entrypoint-initaws.d/import-items.json
    entrypoint: ""
    command: |
      /bin/sh -c '
        /usr/local/bin/docker-entrypoint.sh &
        echo "Waiting for LocalStack to be ready..."
        while ! awslocal dynamodb list-tables 2>/dev/null; do
          echo "Waiting for LocalStack..."
          sleep 2
        done
        echo "LocalStack is ready! Running initialization scripts..."
        sh /docker-entrypoint-initaws.d/init-dynamodb.sh
        tail -f /dev/null
      '

volumes:
  localstack-vol:
    driver: local
