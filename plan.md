# スタッドゲーム エクイティ計算機 実装計画書

## 概要
この文書は、既存のエクイティ計算アプリケーションにスタッドゲームの各種バリアント（Razz、Stud High、Stud High Low 8 or better）を追加するための実装計画を示します。

## 現在のアーキテクチャ分析
現在のコードベースの構成：
- Hold'em、PLO4、PLO5のエクイティ計算を行うpokerパッケージ
- `github.com/chehsunliu/poker`ライブラリを使用したハンド評価
- ハンド対レンジ計算の並列処理機能
- エクイティ計算用のWeb APIエンドポイント
- 結果保存用のPostgreSQLデータベース
- カード画像生成機能

## 実装するゲームバリアント

### 1. Razz（7カードスタッド・ロー）
- **ルール**: プレイヤーは合計7枚のカード（伏せ札3枚、表向き4枚）を受け取り、最も低いハンドが勝利
- **ハンドランキング**: A-5ロー（エースは常に最低）、ストレートとフラッシュは考慮しない
- **最強ハンド**: A-2-3-4-5（ホイール）

### 2. 7カードスタッド・ハイ
- **ルール**: プレイヤーは合計7枚のカード（伏せ札3枚、表向き4枚）を受け取り、最も高いハンドが勝利
- **ハンドランキング**: 標準的なポーカーランキング
- **最強ハンド**: ロイヤルフラッシュ

### 3. 7カードスタッド・ハイロー・8オアベター（Stud 8）
- **ルール**: プレイヤーは合計7枚のカード（伏せ札3枚、表向き4枚）を受け取り、ポットはハイとローで分割
- **ハイハンド**: 標準的なポーカーランキング
- **ローハンド**: 8オアベター条件（8以下の5枚、ペアなし）
- **特殊ケース**: ハイとローで異なるカードを使用可能（スクープ可能）

## 実装戦略

### フェーズ1: コアハンド評価
1. **新しい評価関数の作成**
   - `evaluateRazzHand()`: A-5ローハンドの評価
   - `evaluateStud8LowHand()`: 8オアベターローハンドの評価
   - `evaluateStudHighHand()`: 既存のpoker.Evaluate()を使用

2. **ハンド比較ロジックの実装**
   - `JudgeWinnerRazz()`: Razzハンドの比較
   - `JudgeWinnerStudHigh()`: Stud Highハンドの比較
   - `JudgeWinnerStud8()`: ハイとローの両方を比較、スプリット処理

### フェーズ2: エクイティ計算
1. **スタッドゲーム用のエクイティ計算の適応**
   - 既知のカード数の可変対応（プレイヤーごとに3-7枚）
   - 公開カード（アップカード）vs 非公開カード（ダウンカード）のサポート
   - すべての既知カードに基づく残りデッキの計算

2. **スタッド特有のエクイティ関数の作成**
   - `CalculateStudEquity()`: すべてのスタッドバリアント用の基本関数
   - `CalculateRazzEquity()`: Razz用ラッパー
   - `CalculateStudHighEquity()`: Stud High用ラッパー
   - `CalculateStud8Equity()`: スプリットポット計算の処理

### フェーズ3: データ構造
1. **カード表現の拡張**
   ```go
   type StudHand struct {
       DownCards []poker.Card  // 非公開カード
       UpCards   []poker.Card  // 公開カード
   }
   ```

2. **ゲーム固有の型の作成**
   ```go
   type StudGameType int
   const (
       StudRazz StudGameType = iota
       StudHigh
       StudHighLow8
   )
   ```

3. **エクイティ結果構造体**
   ```go
   type Stud8EquityResult struct {
       HighEquity float64
       LowEquity  float64
       ScoopEquity float64
   }
   ```

### フェーズ4: API統合
1. **新しいエンドポイントの追加**
   - `/api/equity/stud/razz`
   - `/api/equity/stud/high`
   - `/api/equity/stud/highlow8`

2. **リクエスト/レスポンス形式**
   ```json
   // リクエスト
   {
       "yourDownCards": ["As", "2d", "3h"],
       "yourUpCards": ["4c", "5s", "6h", "7d"],
       "opponentKnownCards": ["8s", "9d", "Th", "Jc"],
       "gameType": "razz|high|highlow8"
   }
   
   // レスポンス
   {
       "equity": 65.5,
       "highEquity": 45.2,  // highlow8の場合
       "lowEquity": 20.3,   // highlow8の場合
       "totalSimulations": 990
   }
   ```

### フェーズ5: テスト
1. **ハンド評価のユニットテスト**
   - Razzハンドランキングのテスト
   - 8オアベター条件のテスト
   - スプリットポットシナリオのテスト

2. **エクイティ計算テスト**
   - 既知のエクイティシナリオ
   - エッジケース（ロー条件なし等）

3. **パフォーマンスベンチマーク**
   - 既存のHold'em/PLO計算との比較

### フェーズ6: UI拡張（オプション）
1. **スタッドゲーム選択の追加**
2. **アップ/ダウンカードの個別表示**
3. **Stud 8のハイ/ローエクイティ表示**

## 技術的考慮事項

### 1. ハンド評価ライブラリ
現在の`github.com/chehsunliu/poker`ライブラリはハイハンド評価のみサポート。以下が必要：
- RazzとStud 8用のカスタムローハンド評価の実装
- エース・トゥ・ファイブランキングシステムの作成
- 8オアベター条件ロジックの処理

### 2. パフォーマンス最適化
- 公開カードによりスタッドゲームはより複雑な計算が必要
- 頻繁に計算されるハンドのキャッシュを検討
- 並列エクイティ計算にgoroutineを使用

### 3. データベーススキーマ
- スタッド固有の結果を保存するためのスキーマ拡張が必要な可能性
- ゲームタイプごとの個別テーブルを検討

## タイムライン見積もり
- フェーズ1（コア評価）: 2-3日
- フェーズ2（エクイティ計算）: 3-4日
- フェーズ3（データ構造）: 1日
- フェーズ4（API統合）: 2日
- フェーズ5（テスト）: 2-3日
- フェーズ6（UI - オプション）: 3-4日

**合計: 13-17日**（UI除く）

## 次のステップ
1. この計画のレビューと承認
2. 開発ブランチのセットアップ
3. フェーズ1の実装開始
4. 定期的な進捗更新とコードレビュー